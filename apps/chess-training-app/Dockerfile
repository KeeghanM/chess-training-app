FROM node:22-alpine AS deps
WORKDIR /app

# Copy root package.json and yarn.lock for workspace setup
COPY package.json yarn.lock ./
COPY apps/chess-training-app/package.json ./apps/chess-training-app/

# install all deps including dev
ENV NODE_ENV="development"
RUN yarn install --frozen-lockfile

FROM node:22-alpine AS builder
WORKDIR /app

ENV NODE_ENV="development"
ARG API_BASE_URL
ENV API_BASE_URL=$API_BASE_URL
ARG BREVO_API_KEY
ENV BREVO_API_KEY=$BREVO_API_KEY
ARG DATABASE_URL
ENV DATABASE_URL=$DATABASE_URL
ARG DB_CONNECTION_STRING
ENV DB_CONNECTION_STRING=$DB_CONNECTION_STRING
ARG DB_PASSWORD
ENV DB_PASSWORD=$DB_PASSWORD
ARG DB_USERNAME
ENV DB_USERNAME=$DB_USERNAME
ARG KILLBILL_API_KEY
ENV KILLBILL_API_KEY=$KILLBILL_API_KEY
ARG KILLBILL_API_SECRET
ENV KILLBILL_API_SECRET=$KILLBILL_API_SECRET
ARG KILLBILL_PASSWORD
ENV KILLBILL_PASSWORD=$KILLBILL_PASSWORD
ARG KILLBILL_URL
ENV KILLBILL_URL=$KILLBILL_URL
ARG KILLBILL_USERNAME
ENV KILLBILL_USERNAME=$KILLBILL_USERNAME
ARG KINDE_AUDIENCE
ENV KINDE_AUDIENCE=$KINDE_AUDIENCE
ARG KINDE_CLIENT_ID
ENV KINDE_CLIENT_ID=$KINDE_CLIENT_ID
ARG KINDE_CLIENT_SECRET
ENV KINDE_CLIENT_SECRET=$KINDE_CLIENT_SECRET
ARG KINDE_ISSUER_URL
ENV KINDE_ISSUER_URL=$KINDE_ISSUER_URL
ARG KINDE_POST_LOGIN_REDIRECT_URL
ENV KINDE_POST_LOGIN_REDIRECT_URL=$KINDE_POST_LOGIN_REDIRECT_URL
ARG KINDE_POST_LOGOUT_REDIRECT_URL
ENV KINDE_POST_LOGOUT_REDIRECT_URL=$KINDE_POST_LOGOUT_REDIRECT_URL
ARG KINDE_SITE_URL
ENV KINDE_SITE_URL=$KINDE_SITE_URL
ARG NEXT_PUBLIC_MAX_COURSES
ENV NEXT_PUBLIC_MAX_COURSES=$NEXT_PUBLIC_MAX_COURSES
ARG NEXT_PUBLIC_MAX_SETS
ENV NEXT_PUBLIC_MAX_SETS=$NEXT_PUBLIC_MAX_SETS
ARG NEXT_PUBLIC_POSTHOG_HOST
ENV NEXT_PUBLIC_POSTHOG_HOST=$NEXT_PUBLIC_POSTHOG_HOST
ARG NEXT_PUBLIC_POSTHOG_KEY
ENV NEXT_PUBLIC_POSTHOG_KEY=$NEXT_PUBLIC_POSTHOG_KEY
ARG NEXT_PUBLIC_SITE_URL
ENV NEXT_PUBLIC_SITE_URL=$NEXT_PUBLIC_SITE_URL
ARG NEXT_PUBLIC_STRIPE_PUBLIC_KEY
ENV NEXT_PUBLIC_STRIPE_PUBLIC_KEY=$NEXT_PUBLIC_STRIPE_PUBLIC_KEY
ARG PUZZLE_API_URL
ENV PUZZLE_API_URL=$PUZZLE_API_URL
ARG RAPIDAPI_KEY
ENV RAPIDAPI_KEY=$RAPIDAPI_KEY
ARG REDIS_HOST
ENV REDIS_HOST=$REDIS_HOST
ARG REDIS_PORT
ENV REDIS_PORT=$REDIS_PORT
ARG SMTP_HOST
ENV SMTP_HOST=$SMTP_HOST
ARG SMTP_PASS
ENV SMTP_PASS=$SMTP_PASS
ARG SMTP_PORT
ENV SMTP_PORT=$SMTP_PORT
ARG SMTP_USER
ENV SMTP_USER=$SMTP_USER
ARG STRIPE_PUBLIC_KEY
ENV STRIPE_PUBLIC_KEY=$STRIPE_PUBLIC_KEY
ARG STRIPE_SECRET_KEY
ENV STRIPE_SECRET_KEY=$STRIPE_SECRET_KEY
ARG STRIPE_WEBHOOK_SECRET
ENV STRIPE_WEBHOOK_SECRET=$STRIPE_WEBHOOK_SECRET

COPY --from=deps /app/node_modules ./node_modules

# Copy all source files
COPY . .

# Generate Prisma client
RUN yarn workspace chess-training-app prisma generate

# Build the application
RUN yarn workspace chess-training-app build

FROM node:22-alpine AS runner
WORKDIR /app

ENV NODE_ENV="production"

# Copy necessary files for production
COPY --from=builder /app/apps/chess-training-app/.next ./apps/chess-training-app/.next
COPY --from=builder /app/apps/chess-training-app/public ./apps/chess-training-app/public
COPY --from=builder /app/apps/chess-training-app/package.json ./apps/chess-training-app/package.json
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/yarn.lock ./yarn.lock

# Copy Prisma client
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma

WORKDIR /app/apps/chess-training-app

EXPOSE 3000

CMD ["yarn", "start"]